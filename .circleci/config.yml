version: 2.1

jobs:
  integration-postgres:
    docker:
      - image: cimg/python:3.9.9
      - image: cimg/postgres:14.0
        environment:
          POSTGRES_USER: dbt
          POSTGRES_PASSWORD: dbt
          POSTGRES_DB: dbt

    resource_class: small

    environment:
      DBT_PROFILES_DIR: ./
      INTEGRATION_TEST_RELATION: test_data
      INTEGRATION_TEST_SCHEMA: dbt_profiler_integration_tests_postgres
      POSTGRES_HOST: postgres

    steps:
      - checkout
      - run:
          name: Install dependencies
          command: |
            pip install dbt-postgres
            dbt deps
            dbt --version

  integration-bigquery:
    docker:
      - image: cimg/python:3.9.9

    resource_class: small

    environment:
      DBT_PROFILES_DIR: ./
      BIGQUERY_PROJECT: ${{ secrets.BIGQUERY_PROJECT }}
      BIGQUERY_SERVICE_ACCOUNT_JSON: ${{ secrets.BIGQUERY_SERVICE_ACCOUNT_JSON }}
      BIGQUERY_KEYFILE: ./bigquery-service-key.json

    steps:
      - checkout
      - run:
          name: Install dependencies
          command: |
            pip install dbt-bigquery
            dbt deps
            dbt --version

workflows:
  version: 2
  continuous-integration:
    jobs:
      - integration-postgres
      - approve:
          type: approval
      - integration-bigquery:
          requires:
            - approve